## 过期删除策略

### 如何设置过期时间？

```
- expire <key> <n>：设置 key 在 n 秒后过期
- pexpire <key> <n>：设置 key 在 n 毫秒后过期
- expireat <key> <n>：设置 key 在某个时间戳（精确到秒）之后过期
- pexpireat <key> <n>：设置 key 在某个时间戳（精确到毫秒）之后过期
```

设置字符串时，也可以同时对 key 设置过期时间，共有 3 种命令

```
- set <key> <value> ex <n> ：设置键值对的时候，同时指定过期时间（精确到秒）；
- set <key> <value> px <n> ：设置键值对的时候，同时指定过期时间（精确到毫秒）；
- setex <key> <n> <valule> ：设置键值对的时候，同时指定过期时间（精确到秒）。
```

### 如何判定 key 已过期了？

```
每当我们对一个 key 设置了过期时间时，Redis 会把该 key 带上过期时间存储到一个过期字典（expires dict）中，也就是说「过期字典」保存了数据库中所有 key 的过期时间。
```

查询key的流程

```
当我们查询一个 key 时，Redis 首先检查该 key 是否存在于过期字典中：
- 如果不在，则正常读取键值；
- 如果存在，则会获取该 key 的过期时间，然后与当前系统时间进行比对，如果比系统时间大，那就没有过期，否则判定该 key 已过期
```

### 过期删除策略有哪些？

```
（1）定时删除；
（2）惰性删除；
（3）定期删除；
```

#### 定时删除

```
在设置 key 的过期时间时，同时创建一个定时事件，当时间到达时，由事件处理器自动执行 key 的删除操作。
```

优缺点

```
（1）优点：
		- 内存友好：可以保证过期 key 会被尽快删除，也就是内存可以被尽快地释放。因此，定时删除对内存是最友好的。
（2）缺点：
		- CPU不友好：在过期 key 比较多的情况下，删除过期 key 可能会占用相当一部分 CPU 时间，在内存不紧张但 CPU 时间紧张的情况下，将 CPU 时间用于删除和当前任务无关的过期键上，无疑会对服务器的响应时间和吞吐量造成影响。所以，定时删除策略对 CPU 不友好。
```

#### 惰性删除

```
不主动删除过期键，每次从数据库访问 key 时，都检测 key 是否过期，如果过期则删除该 key。
```

优缺点

```
（1）优点：
		- 因为每次访问时，才会检查 key 是否过期，所以此策略只会使用很少的系统资源，因此，惰性删除策略对 CPU 时间最友好。
（2）缺点：
		- 一直没有被访问，就会一直占内存
```

#### 定期删除

```
每隔一段时间「随机」从数据库中取出一定数量的 key 进行检查，并删除其中的过期key。
```

优缺点

```
（1）优点
		- 通过限制删除操作执行的时长和频率，来减少删除操作对 CPU 的影响，同时也能删除一部分过期的数据减少了过期键对空间的无效占用。
（2）缺点
		- 内存清理方面没有定时删除效果好，同时没有惰性删除使用的系统资源少。
		- 频率不好确定：难以确定删除操作执行的时长和频率。如果执行的太频繁，定期删除策略变得和定时删除策略一样，对CPU不友好；如果执行的太少，那又和惰性删除一样了，过期 key 占用的内存不会及时得到释放。
```

### Redis 过期删除策略是什么？

```
Redis 选择「惰性删除+定期删除」这两种策略配和使用，以求在合理使用 CPU 时间和避免内存浪费之间取得平衡。

定期时间：每秒10次过期检查
抽查数量：20
如果每次抽查，过期数量1/4，则再取20个
```

## 内存淘汰策略

### 是什么

```
Redis 的运行内存已经超过 Redis 设置的最大内存之后，则会使用内存淘汰策略删除符合条件的 key，以此来保障 Redis 高效的运行。
```

### Redis 内存淘汰策略有哪些？

```
不淘汰：
（1）no-eviction：禁止驱逐数据，也就是说当内存不足以容纳新写入数据时，新写入操作会报错。

过期数据中淘汰：
（1）volatile-random：随机淘汰设置了过期时间的「任意键值」；
（2）volatile-ttl：优先淘汰「更早过期」的键值。
（3）volatile-lru（Redis3.0 之前，默认的内存淘汰策略）：淘汰所有设置了过期时间的键值中，「最久未使用」的键值；
（4）volatile-lfu（Redis 4.0 后新增的内存淘汰策略）：淘汰所有设置了过期时间的键值中，「最少使用」的键值；

所有范围内淘汰：
（1）allkeys-random：「随机」淘汰任意键值;
（2）allkeys-lru：淘汰整个键值中「最久未使用」的键值；
（3）allkeys-lfu（Redis 4.0 后新增的内存淘汰策略）：淘汰整个键值中「最少使用」的键值。
```

参考

-   https://xiaolincoding.com/redis/module/strategy.html#redis-内存淘汰策略有哪些
-   https://javaguide.cn/database/redis/redis-questions-01.html#redis-内存淘汰机制了解么

